### Introduction

This document outlines the implementation of a cell value distribution chart. The purpose of this feature is to provide users with immediate visual feedback on the composition of aggregated values within table cells, specifically for `FillTableNode`.

When a user selects a cell in a table generated by one of these nodes, a floating chart will appear, displaying a histogram of the raw log values that were used to calculate the aggregated value for that cell. This allows users to quickly understand the data distribution, identify outliers, and gain confidence in their data processing workflows.

---

### Implementation Details

#### Phase 1: Worker Data Caching & Retrieval

- [ ] **Modify `FillTableWorker.ts`:**

  - Update the worker logic to cache the raw log values that contribute to each cell of the output table. A `Map<string, number[]>` where the key is a string identifier like `"row,col"` will be used to store the array of values for each cell.

- [ ] **Implement New Worker Message:**
  - Define a new message type for requesting the raw data for a specific cell (e.g., `{ type: 'GET_CELL_DATA', payload: { row: number, col: number } }`).
  - Implement the `onmessage` logic in the worker to handle this request. When triggered, it will look up the data in its cache and `postMessage` the array of values back to the main thread.

#### Phase 2: State Management for Chart

- [ ] **Create a new Zustand Store (`app/store/useDistributionChart.ts`):**
  - Define a state to manage the chart's data and appearance.
    - `values: number[]`: The array of numbers to be plotted.
    - `isOpen: boolean`: Controls the visibility of the chart.
    - `position: { x: number, y: number }`: The screen coordinates for positioning the chart.
  - Define actions:
    - `showChart(values, position)`: Sets the data and position, and sets `isOpen` to `true`.
    - `hideChart()`: Sets `isOpen` to `false`.

#### Phase 3: Chart Component

- [x] **Install Charting Library:**

  - Install `echarts-for-react` to render the chart.
    ```bash
    npm install echarts-for-react echarts
    ```

- [ ] **Create `CellDistributionChart.tsx`:**
  - Create a new component at `app/_components/CellDistributionChart.tsx`.
  - This component will subscribe to the `useDistributionChart` store.
  - When `isOpen` is `true`, it will render a floating `div` at the specified `position`.
  - It will use `echarts-for-react` to render a histogram based on the `values` from the store.
  - The component will include a close button that calls the `hideChart` action.

#### Phase 4: Integration with UI Components

- [ ] **Update `TableUI.tsx`:**

  - Add a new optional prop: `onCellSelect?: (row: number, col: number, event: React.MouseEvent) => void`.
  - In the `cellOnMouseDown` or `cellOnMouseUp` event handler, invoke this new prop if it exists, passing the cell coordinates and the mouse event.

- [ ] **Update `FillTableNode.tsx`:**

  - In the node components, pass the new `onCellSelect` handler to `RomModuleUI` (and subsequently to `TableUI`).
  - This `onCellSelect` handler will contain the core logic:
    1.  Get the mouse event to determine the desired position for the chart.
    2.  Call `hideChart()` from the `useDistributionChart` store to close any previously opened chart.
    3.  Post the `GET_CELL_DATA` message to the node's worker with the selected cell's `row` and `col`.

- [ ] **Update Node Worker Message Handling:**

  - In the node's `onmessage` handler (for messages from the worker), add a case to listen for the cell data response.
  - Upon receiving the data, call `showChart(data, position)` from the `useDistributionChart` store to render the chart with the received values.

- [ ] **Add Chart to Global Layout:**
  - Render the `<CellDistributionChart />` component in a global layout file, such as `app/_components/Flow.tsx`, to ensure it can float above all other UI elements.

#### Phase 5: Testing

- [ ] **Perform Manual Integration Testing:**
  - Add a `FillTableNode` to the canvas and connect its inputs to produce a table.
  - Select a cell in the output table.
  - **Verify:** A distribution chart (histogram) appears next to the cursor.
  - **Verify:** The chart displays a plausible distribution for the underlying data.
  - Select a different cell and verify that the chart updates with the new cell's data.
  - Click the chart's close button or click outside the table area to verify the chart disappears.
  - Test edge cases, such as cells with no data points or cells with only a single data point.
